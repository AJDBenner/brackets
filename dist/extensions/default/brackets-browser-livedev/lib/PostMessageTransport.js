define(function(require,exports,module){"use strict";var _iframeRef,connId=1;var Launcher=require("./launcher");var EventDispatcher=brackets.getModule("utils/EventDispatcher"),LiveDevMultiBrowser=brackets.getModule("LiveDevelopment/LiveDevMultiBrowser"),BlobUtils=brackets.getModule("filesystem/impls/filer/BlobUtils"),Path=brackets.getModule("filesystem/impls/filer/BracketsFiler").Path;var PostMessageTransportRemote=require("text!lib/PostMessageTransportRemote.js");EventDispatcher.makeEventDispatcher(module.exports);function setIframe(iframeRef){if(iframeRef){_iframeRef=iframeRef}}function _listener(event){var msgObj;try{msgObj=JSON.parse(event.data)}catch(e){return}if(msgObj.type==="message"){module.exports.trigger("message",[connId,msgObj.message])}}function start(){window.addEventListener("message",_listener)}function resolveLinks(message){var currentDoc=LiveDevMultiBrowser._getCurrentLiveDoc();if(!currentDoc){return message}var currentDir=Path.dirname(currentDoc.doc.file.fullPath);var linkRegex=new RegExp('\\"(href|src)\\":\\"([^"]+)\\"',"gm");var resolvedMessage=message.replace(linkRegex,function(match,attr,path){path=BlobUtils.getUrl(path.charAt(0)==="/"?path:Path.join(currentDir,path));return['"',attr,'":"',path,'"'].join("")});return resolvedMessage}function send(idOrArray,msgStr){var win=_iframeRef.contentWindow;var msg=JSON.parse(msgStr);if(msg.method==="Page.reload"||msg.method==="Page.navigate"){reload();return}if(msg&&msg.params&&msg.params.expression){msg.params.expression=resolveLinks(msg.params.expression)}win.postMessage(JSON.stringify(msg),"*")}function close(clientId){window.removeEventListener("message",_listener)}function getRemoteScript(){return"<script>\n"+PostMessageTransportRemote+"</script>\n"}function reload(){var launcher=Launcher.getCurrentInstance();var liveDoc=LiveDevMultiBrowser._getCurrentLiveDoc();var url=BlobUtils.getUrl(liveDoc.doc.file.fullPath);launcher.launch(url)}module.exports.getRemoteScript=getRemoteScript;module.exports.setIframe=setIframe;module.exports.start=start;module.exports.send=send;module.exports.close=close;module.exports.reload=reload});